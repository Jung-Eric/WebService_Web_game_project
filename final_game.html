<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Javascript Game</title>
        <style>
        * { padding: 0; margin: 0; }
        canvas { background: #eee; display: block; margin: 0 auto; }
        </style>
        <script>
            var context;
            var context2;

            document.addEventListener("mousemove", mouseMoveHandler, false);

            var backimage = new Image();
            backimage.src = "images/Chess_board_all.png";

            var cpw1 = new Image();
            cpw1.src = "images/WP.png";
            var cpw2 = new Image();
            cpw2.src = "images/WS.png";
            var cpw3 = new Image();
            cpw3.src = "images/WD.png";
            var cpw4 = new Image();
            cpw4.src = "images/WB.png";
            var cpw5 = new Image();
            cpw5.src = "images/WC.png";
            var cpw6 = new Image();
            cpw6.src = "images/WF.png";
            var cpw7 = new Image();
            cpw7.src = "images/WK.png";
            var cpw8 = new Image();
            cpw8.src = "images/WQ.png";

            var cpr1 = new Image();
            cpr1.src = "images/RP.png";
            var cpr2 = new Image();
            cpr2.src = "images/RS.png";
            var cpr3 = new Image();
            cpr3.src = "images/RD.png";
            var cpr4 = new Image();
            cpr4.src = "images/RB.png";
            var cpr5 = new Image();
            cpr5.src = "images/RC.png";
            var cpr6 = new Image();
            cpr6.src = "images/RF.png";
            var cpr7 = new Image();
            cpr7.src = "images/RK.png";
            var cpr8 = new Image();
            cpr8.src = "images/RQ.png";

            var block_box = new Image();
            block_box.src = "images/block_box.png";

            var block_sel = new Image();
            block_sel.src = "images/block_selection.png";

            var block_sel_blue = new Image();
            block_sel_blue.src = "images/block_selection_blue.png";

            var block_sel_red = new Image();
            block_sel_red.src = "images/block_selection_red.png";

            var chess_piece_W = [cpw1,cpw1,cpw2,cpw2,cpw3,cpw4,cpw5,cpw6,cpw7,cpw8];
            var chess_piece_R = [cpr1,cpr1,cpr2,cpr2,cpr3,cpr4,cpr5,cpr6,cpr7,cpr8];
            var selected = [block_sel,block_sel_blue,block_sel_red];


            var score = 0; //점수

            var timer; /*타이머 객체 변수*/

            var base_x = 70 + 10;
            var base_y = 20 + 10;

            var add_y = 5;

            //var arr_w = [-1,-1,-1,-1,-1,-1,-1,-1,-1];
            var ban_r = [-1,-1];
            var ban_w = [-1,-1];

            var step = 0;
            var turn = 0;

            var ban_table = [1,3,4,5,6,2,7]
            //var arr_r = [6,7,-1,-1,-1,-1,-1,-1,12];

            //var arr_w = [1,2,-1,-1,5,-1,-1,21,23];
            var posX = 0
            var posY = 0

            //------------------------------------------------------
            //기존 수행
            setInterval(draw,10);
            //setInterval(UI, 10);
            //------------------------------------------------------


            /*배경을 화면에 그린다*/
            function drawBackground() {
                context.drawImage(backimage, 70, 20,340,500);

                //context.drawImage(backimage, posX, posY,340,500);
            }

            function draw_chess(){
              for(i = 0; i<10; i++){
                if (arr_w[i] != -1){
                  var pos_x = (arr_w[i] & 3)
                  var pos_y = 5 - (arr_w[i] >> 2)

                  if (i != 2 && i != 3){
                  context.drawImage(chess_piece_W[i], base_x+(pos_x * 80), base_y-add_y+(pos_y * 80),80,80);
                  }
                  else if(i == 2){
                    context.drawImage(chess_piece_W[2], base_x+(pos_x * 80), base_y-add_y+(pos_y * 80),160,80);
                  }

                }
              }

              for(i = 0; i<10; i++){
                if (arr_r[i] != -1){
                  var pos_x = (arr_r[i] & 3)
                  var pos_y = 5 - (arr_r[i] >> 2)
                  if (i != 2 && i != 3){
                  context.drawImage(chess_piece_R[i], base_x+(pos_x * 80), base_y-add_y+(pos_y * 80),80,80);
                  }
                  else if(i == 2){
                    context.drawImage(chess_piece_R[2], base_x+(pos_x * 80)-80, base_y-add_y+(pos_y * 80),160,80);
                  }
                }
              }
            }

            /*전체 화면을 그리는 함수*/
            function draw() {
                //context.clearRect(0, 0, 500, 300);

                drawBackground();
                draw_chess();
                writeGuide();
                UI();
            }

            function UI(){
              if (step==3){

                for (imp_y = 0; imp_y < 6; imp_y++){
                  for (imp_x = 0; imp_x < 4; imp_x ++){

                    imp_y2 = 5 - imp_y

                    if (arr_w.includes(imp_y*4 + imp_x)) {

                      if( (posX>base_x+(80*imp_x) && posX<base_x+80+(80*imp_x)) && (posY>base_y+(80*imp_y2) && posY<base_y+80+(80*imp_y2)) ){
                        context.drawImage(selected[0], base_x+(80*imp_x), base_y+(80*imp_y2),80,80);
                      }

                    }

                  }
                }



              }
            }

            function writeGuide() {
              if (step==0){
                context.drawImage(block_box, 50,50,380,120);

                context.font = "24px Arial";
                context.textAlign = "center"
                context.fillStyle = "#0095DD";

                //context.fillText("Lives: "+lives, canvas.width-65, 20);
                context.fillText("선공입니다.", 240,100);

                context.font = "20px Arial";
                context.fillText("금지할 상대 말을 고르세요", 240,135);

                for(i = 0; i<4; i++){
                  context.drawImage(block_box,100*i+50,190,80,80);
                  context.drawImage(chess_piece_R[ban_table[i]],100*i+50,190,80,80);
                  }

                  context.drawImage(block_box,50+10,300,80,80);
                  context.drawImage(chess_piece_R[ban_table[4]],50+10,300,80,80);

                  context.drawImage(block_box,150+10,300,160,80);
                  context.drawImage(chess_piece_R[ban_table[5]],150+10,300,160,80);

                  context.drawImage(block_box,330+10,300,80,80);
                  context.drawImage(chess_piece_R[ban_table[6]],330+10,300,80,80);

              }


            }

            function mouseMoveHandler(e) {
            var relativeX = e.clientX - canvas.offsetLeft;
            var relativeY = e.clientY - canvas.offsetTop;
            if(relativeX > 0 && relativeX < canvas.width) {
              if(relativeX > 0 && relativeY < canvas.height){
                posX = relativeX;
                posY = relativeY;
              }
            }
            }

            //초기화 목적
            //맨 처음에 이게 시전된다.
            function init() {
              //arr_w = [-1,-1,-1,-1,-1,-1,-1,-1,-1];
              //arr_r = [-1,-1,-1,-1,-1,-1,-1,-1,-1];

              ban_r = [-1,-1];
              ban_w = [-1,-1];

              arr_w = [4,7,5,6,3,0,-1,-1,2,1];
              arr_r = [19,16,18,17,20,23,-1,-1,21,22];

              step = 3;

                context = document.getElementById('canvas').getContext('2d');
                drawBackground();
                draw();
            }

            /*사용자가 발사 버튼을 누르면 호출된다.*/
            function start() {
                init();
                velocity = Number(document.getElementById('velocity').value);
                angle = Number(document.getElementById('angle').value);
                var angleR = angle * Math.PI / 180;

                ballVx = velocity * Math.cos(angleR);
                ballVy = -velocity * Math.sin(angleR);

                draw();
                timer = setInterval(calculate, 100);
                return false
            }

            /*공의 현재 속도와 위치를 업데이트한다.*/
            function calculate() {
                ballVy = ballVy + 1.98;

                ballX = ballX + ballVx;
                ballY = ballY + ballVy;

                /*공이 목표물에 맞았으면*/
                if ((ballX >= 450) && (ballX <= 480) && (ballY >= 60) && (ballY <= 210)) {
	                score++;
	                document.getElementById("score").innerHTML = "점수= " + score;
	                clearInterval(timer);
                }
                /*공이 경계를 벗어났으면*/
                if (ballY >= 300 || ballY < 0) {
                    clearInterval(timer);
                }
                draw();
            }

        </script>
    </head>
    <body onload="init();">
        <canvas id="canvas" width="480" height="540"></canvas>
        <div id="control">
            속도 <input id="velocity" value="30" type="number" min="0" max="100" step="1">
            각도 <input id="angle" value="45" type="number" min="0" max="90" step="1">
            <div id="score">점수 = 0</div>
            <button onclick="start()">발사</button>
        </div>
    </body>
</html>
