<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Javascript Game</title>
        <style>
        * { padding: 0; margin: 0; }
        canvas { background: #eee; display: block; margin: 0 auto; }
        </style>
        <script>
            var context;
            var context2;

            document.addEventListener("mousemove", mouseMoveHandler, false);
            document.addEventListener("mousedown", mouseDownHandler, false);

            var backimage = new Image();
            backimage.src = "images/Chess_board_all.png";

            var cpw1 = new Image();
            cpw1.src = "images/WP.png";
            var cpw2 = new Image();
            cpw2.src = "images/WS.png";
            var cpw3 = new Image();
            cpw3.src = "images/WD.png";
            var cpw4 = new Image();
            cpw4.src = "images/WB.png";
            var cpw5 = new Image();
            cpw5.src = "images/WC.png";
            var cpw6 = new Image();
            cpw6.src = "images/WF.png";
            var cpw7 = new Image();
            cpw7.src = "images/WK.png";
            var cpw8 = new Image();
            cpw8.src = "images/WQ.png";

            var cpr1 = new Image();
            cpr1.src = "images/RP.png";
            var cpr2 = new Image();
            cpr2.src = "images/RS.png";
            var cpr3 = new Image();
            cpr3.src = "images/RD.png";
            var cpr4 = new Image();
            cpr4.src = "images/RB.png";
            var cpr5 = new Image();
            cpr5.src = "images/RC.png";
            var cpr6 = new Image();
            cpr6.src = "images/RF.png";
            var cpr7 = new Image();
            cpr7.src = "images/RK.png";
            var cpr8 = new Image();
            cpr8.src = "images/RQ.png";

            var block_box = new Image();
            block_box.src = "images/block_box.png";

            var block_sel = new Image();
            block_sel.src = "images/block_selection.png";

            var block_sel_blue = new Image();
            block_sel_blue.src = "images/block_selection_blue.png";

            var block_sel_red = new Image();
            block_sel_red.src = "images/block_selection_red.png";

            var chess_piece_W = [cpw1,cpw1,cpw2,cpw2,cpw3,cpw4,cpw5,cpw6,cpw7,cpw8];
            var chess_piece_R = [cpr1,cpr1,cpr2,cpr2,cpr3,cpr4,cpr5,cpr6,cpr7,cpr8];
            var selected = [block_sel,block_sel_blue,block_sel_red];


            var score = 0; //점수

            var timer; /*타이머 객체 변수*/

            var base_x = 70 + 10;
            var base_y = 20 + 10;

            var add_y = 5;

            //var arr_w = [-1,-1,-1,-1,-1,-1,-1,-1,-1];
            var ban_r = [-1,-1];
            var ban_w = [-1,-1];

            var step = 0;
            var turn = 0;

            var ban_table = [1,3,4,5,6,2,7];
            //var arr_r = [6,7,-1,-1,-1,-1,-1,-1,12];

            //var arr_w = [1,2,-1,-1,5,-1,-1,21,23];
            var posX = 0;
            var posY = 0;

            var posC = -1;
            var posCX = 0;
            var posCY = 0;

            var errors = false;

            var arr_range = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];

            //------------------------------------------------------
            //기존 수행
            setInterval(draw,10);
            //setInterval(UI, 10);
            //------------------------------------------------------


            /*배경을 화면에 그린다*/
            function drawBackground() {
                context.drawImage(backimage, 70, 20,340,500);

                //context.drawImage(backimage, posX, posY,340,500);
            }

            function draw_chess(){
              for(i = 0; i<10; i++){
                if (arr_w[i] != -1){
                  var pos_x = (arr_w[i] & 3)
                  var pos_y = 5 - (arr_w[i] >> 2)

                  if (i != 2 && i != 3){
                  context.drawImage(chess_piece_W[i], base_x+(pos_x * 80), base_y-add_y+(pos_y * 80),80,80);
                  }
                  else if(i == 2){
                    context.drawImage(chess_piece_W[2], base_x+(pos_x * 80), base_y-add_y+(pos_y * 80),160,80);
                  }

                }
              }

              for(i = 0; i<10; i++){
                if (arr_r[i] != -1){
                  var pos_x = (arr_r[i] & 3)
                  var pos_y = 5 - (arr_r[i] >> 2)
                  if (i != 2 && i != 3){
                  context.drawImage(chess_piece_R[i], base_x+(pos_x * 80), base_y-add_y+(pos_y * 80),80,80);
                  }
                  else if(i == 2){
                    context.drawImage(chess_piece_R[2], base_x+(pos_x * 80)-80, base_y-add_y+(pos_y * 80),160,80);
                  }
                }
              }
            }

            /*전체 화면을 그리는 함수*/
            function draw() {
                //context.clearRect(0, 0, 500, 300);

                //클릭 좌표 연산
                clickMaker();

                drawBackground();
                draw_chess();
                writeGuide();

                StepShifter();

                rangeMaker();
                UI();


            }

            function StepShifter(){
              if (step==3){
                if (posC != -1){
                  if ( arr_w.includes(posC) ){
                    step = 4;
                  }
                }
              }
              else if (step ==4){
                if (posC == -1){
                  step = 3;
                  arr_range = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];
                }

              }


            }

            //클릭 좌표를 받아온다.
            function clickMaker(){
                if ( ( (posCX >= base_x) && (posCX < base_x+320)) && ( (posCY >= base_y) && (posCY < base_y+480)) ){
                  //var imp_x = parseInt (posCX-base_x / 80);
                  var imp_x = parseInt ((posCX-base_x) / 80);
                  var imp_y = 5 - parseInt ((posCY-base_y) / 80);
                  posC = (imp_y << 2) + imp_x;

                }
                else{
                  posC = -1
                }
            }

            function rangeMaker(){
              if (step==4){
                if (arr_w.includes(posC)){
                  var imp_order = arr_w.indexOf(posC);
                  switch(imp_order){
                    //pawn1
                    case 0:
                      p_move(0);
                      break;
                    case 1:
                      p_move(1);
                      break;
                    case 2:
                      s_move();
                      break;
                    case 3:
                      s_move();
                      break;
                    case 4:
                      d_move();
                      break;
                    case 5:
                      b_move();
                      break;


                  }
                }
              }
            }

            function UI(){
              if (step==3){

                for (imp_y = 0; imp_y < 6; imp_y++){
                  for (imp_x = 0; imp_x < 4; imp_x++){

                    imp_y2 = 5 - imp_y

                    if (arr_w.includes(imp_y*4 + imp_x)) {

                      if( (posX>base_x+(80*imp_x) && posX<base_x+80+(80*imp_x)) && (posY>base_y+(80*imp_y2) && posY<base_y+80+(80*imp_y2)) ){
                        context.drawImage(selected[0], base_x+(80*imp_x), base_y+(80*imp_y2),80,80);
                      }

                    }

                  }
                }
              }
              //터치 한 상태에서 보여준다.
              else if (step==4){
                //var imp_x = posC & 3;
                //var imp_y = 5 - (posC >> 2);
                x_4 = posC & 3;
                y_4 = 5 - (posC >> 2);
                context.drawImage(selected[0], base_x+(80*x_4), base_y+(80*y_4),80,80);


                for (imp_y = 0; imp_y < 6; imp_y++){
                  for (imp_x = 0; imp_x < 4; imp_x++){
                    imp_y2 = 5 - imp_y;

                      if(arr_range[imp_y][imp_x] ==2){
                        context.drawImage(selected[2], base_x+(80*imp_x), base_y+(80*imp_y2),80,80);
                      }
                      else if(arr_range[imp_y][imp_x] ==1){
                        context.drawImage(selected[1], base_x+(80*imp_x), base_y+(80*imp_y2),80,80);
                      }

                  }
                }



              }
            }

            function writeGuide() {
              context.clearRect(20, 0, 600, 30);
              context.font = "20px Arial";
              context.textAlign = "center"
              context.fillStyle = "#0095DD";
              //context.fillText(posCX, 200,18);
              //context.fillText(posCY, 300,18);


              for (imp_x=0; imp_x <4; imp_x++){
                for (imp_y=0; imp_y <6; imp_y++){
                context.fillText(arr_range[imp_y][imp_x], 50+(imp_x*10)+(imp_y*50),18);
                }
              }
              context.fillText(errors, 370,18);

              context.fillText(arr_w[0], 400,18);

              /*
              context.fillText(arr_range[2][0], 110,18);
              context.fillText(arr_range[2][1], 120,18);
              context.fillText(arr_range[2][2], 130,18);
              context.fillText(arr_range[2][3], 140,18);
              */
              context.fillText(posC, 420,18);


              if (step==0){
                context.drawImage(block_box, 50,50,380,120);

                context.font = "24px Arial";
                context.textAlign = "center"
                context.fillStyle = "#0095DD";

                //context.fillText("Lives: "+lives, canvas.width-65, 20);
                context.fillText("선공입니다.", 240,100);

                context.font = "20px Arial";
                context.fillText("금지할 상대 말을 고르세요", 240,135);

                for(i = 0; i<4; i++){
                  context.drawImage(block_box,100*i+50,190,80,80);
                  context.drawImage(chess_piece_R[ban_table[i]],100*i+50,190,80,80);
                  }

                  context.drawImage(block_box,50+10,300,80,80);
                  context.drawImage(chess_piece_R[ban_table[4]],50+10,300,80,80);

                  context.drawImage(block_box,150+10,300,160,80);
                  context.drawImage(chess_piece_R[ban_table[5]],150+10,300,160,80);

                  context.drawImage(block_box,330+10,300,80,80);
                  context.drawImage(chess_piece_R[ban_table[6]],330+10,300,80,80);

              }


            }

            function mouseDownHandler(e){
              var relativeX = e.clientX - canvas.offsetLeft;
              var relativeY = e.clientY - canvas.offsetTop;
              if(relativeX > 0 && relativeX < canvas.width) {
                if(relativeX > 0 && relativeY < canvas.height){
                  posCX = relativeX;
                  posCY = relativeY;
                }
                }
                draw();
            }

            function mouseMoveHandler(e) {
            var relativeX = e.clientX - canvas.offsetLeft;
            var relativeY = e.clientY - canvas.offsetTop;
            if(relativeX > 0 && relativeX < canvas.width) {
              if(relativeX > 0 && relativeY < canvas.height){
                posX = relativeX;
                posY = relativeY;
              }
              }

            }

            function pos_maker(imp_pos,d,arr_imp){

                if (imp_pos == -1){
                  return -1;
                }
                var pos_x = imp_pos & 3;
                var pos_y = imp_pos >> 2;

                //errors = imp_pos;
                //pawn1
                if (d == 0){

                  if (pos_x > 0 && pos_y < 5){
                    pos_x = pos_x-1;
                    pos_y = pos_y+1;
                    var ret = (pos_y << 2)+pos_x;

                    if (arr_imp.includes(ret)){
                      return -1;
                    }
                    else{
                      return ret;
                    }

                  }
                  else{
                    return -1;
                  }

                }
                else if (d==1){

                  if (pos_y < 5){
                    pos_y = pos_y+1
                    var ret = (pos_y << 2)+pos_x;
                    if (arr_imp.includes(ret)){
                      //errors = imp_pos;

                      return -1;
                    }
                    else{
                      //errors = imp_pos;

                      return ret;
                    }
                  }
                  else{
                    return -1;
                  }

                }

                else if(d==2){
                  if (pos_x < 3 && pos_y < 5){
                    pos_x = pos_x+1;
                    pos_y = pos_y+1;
                    var ret = (pos_y << 2)+pos_x;

                    if (arr_imp.includes(ret)){

                      return -1;
                    }
                    else{
                      return ret;
                    }
                  }
                  else{
                    return -1;
                  }

                }
                else if(d==3){
                  if (pos_x < 3 ){
                    pos_x = pos_x+1
                    var ret = (pos_y << 2)+pos_x;

                    if (arr_imp.includes(ret)){

                      return -1;
                    }
                    else{
                      return ret;
                    }
                  }
                  else{
                    return -1;
                  }
                }

                else if(d==4){
                  if (pos_x < 3 && pos_y > 0){
                    pos_x = pos_x+1;
                    pos_y = pos_y-1;
                    var ret = (pos_y << 2)+pos_x;

                    if (arr_imp.includes(ret)){

                      return -1;
                    }
                    else{
                      return ret;
                    }
                  }
                  else{
                    return -1;
                  }
                }

                else if(d==5){
                  if (pos_y > 0){
                    pos_y = pos_y-1;
                    var ret = (pos_y << 2)+pos_x;

                    if (arr_imp.includes(ret)){

                      return -1;
                    }
                    else{
                      return ret;
                    }
                  }
                  else{
                    return -1;
                  }
                }

                else if(d==6){
                  if (pos_x > 0 && pos_y > 0){
                    pos_x = pos_x-1;
                    pos_y = pos_y-1;
                    var ret = (pos_y << 2)+pos_x;

                    if (arr_imp.includes(ret)){

                      return -1;
                    }
                    else{
                      return ret;
                    }
                  }
                  else{
                    return -1;
                  }
                }

                else if(d==7){
                  if (pos_x > 0){
                    pos_x = pos_x-1;
                    var ret = (pos_y << 2)+pos_x;

                    if (arr_imp.includes(ret)){

                      return -1;
                    }
                    else{
                      return ret;
                    }
                  }
                  else{
                    return -1;
                  }
                }
                else {
                  return -1;
                }

                return -1;

            }

            function p_move(type){
              range_reset();

              var pos_target = arr_w[type];
              //혹시라혿 없을 경우
              if (pos_target == -1){
                return;
              }
              //값이 있을 경우
              else{
                for (i = 0;i<3;i++){
                    //errors = i;
                  if (i == 0 || i == 2){
                    //errors = i;
                    //errors = pos_maker(8,0);
                    var cal_pos = pos_maker(pos_target,i,arr_w);

                    //errors = cal_pos;
                    if (cal_pos != -1){
                      var check_pos = arr_r.includes(cal_pos);


                      if (check_pos == true){
                        var imp_order = arr_r.indexOf(cal_pos);
                        if (imp_order != 2 && imp_order != 3){
                          var imp_x = cal_pos & 3;
                          var imp_y = cal_pos >> 2;

                          arr_range[imp_y][imp_x] = 2;

                        }
                      }
                      else{
                        //errors = cal_pos;
                        //여긴 비어있다.
                      }
                    }

                  }//0,2의 수행
                  else if(i == 1){
                    var cal_pos = pos_maker(pos_target,i,arr_w);

                    if (cal_pos != -1){
                      var check_pos = arr_r.includes(cal_pos);
                      if (check_pos == true){
                        if (imp_order != 2 && imp_order != 3){
                          var imp_x = cal_pos & 3;
                          var imp_y = cal_pos >> 2;

                          arr_range[imp_y][imp_x] = 2;

                        }

                      }
                      else{
                        var imp_x = cal_pos & 3;
                        var imp_y = cal_pos >> 2;

                        arr_range[imp_y][imp_x] = 1;
                      }

                    }

                  }//1의 수행

                }//반복문

              }//값이 있는 경우

            }//p1_move


            function s_move(){
              range_reset();

              var pos_target = arr_w[2];

              //혹시라혿 없을 경우
              if (pos_target == -1){
                return;
              }
              //값이 있을 경우
              else{
                var cal_pos1 = pos_maker(pos_target,1,arr_w);
                var cal_pos2 = pos_maker(pos_target,2,arr_w);

                var cal_check1 = pos_maker(pos_target,1,arr_r);
                var cal_check2 = pos_maker(pos_target,2,arr_r);

                if(cal_pos1 != -1 && cal_pos2 != -1){
                  if (cal_check1 != -1 && cal_check2 != -1){
                    var imp_x = cal_pos1 & 3;
                    var imp_y = cal_pos1 >> 2;

                    arr_range[imp_y][imp_x] = 1;
                    arr_range[imp_y][imp_x+1] = 1;
                  }
                }//명령 수행
              }
            }//s_move

            //후계자 이동
            function d_move(){
              range_reset();

              var pos_target = arr_w[4];

              if (pos_target == -1){
                return;
              }

              else{
                var cal_pos = [-1,-1];
                cal_pos[0] = pos_maker(pos_target,1,arr_w);
                cal_pos2 = pos_maker(pos_target,1,arr_test);
                cal_pos[1] = pos_maker(cal_pos2,1,arr_w);

                for (i=0;i<2;i++){

                if (cal_pos[i] != -1){
                  var check_pos = arr_r.includes(cal_pos[i]);
                  if (check_pos == true){
                    var imp_order = arr_r.indexOf(cal_pos[i]);
                    if (imp_order != 2 && imp_order != 3){
                      var imp_x = cal_pos & 3;
                      var imp_y = cal_pos >> 2;

                      arr_range[imp_y][imp_x] = 2;

                    }

                  }
                  else{
                    var imp_x = cal_pos[i] & 3;
                    var imp_y = cal_pos[i] >> 2;

                    arr_range[imp_y][imp_x] = 1;
                  }
                }//cal 구간
              }

              }
            }//후계자 이동


            function b_move(){
              range_reset();

              var pos_target = arr_w[5];

              if (pos_target == -1){
                return;
              }

              else{
                for (i = 0;i<4;i++){
                    var imp_couter = 0;
                    var imp_sub = pos_target;

                    while(true){
                      var cal_pos = pos_maker(pos_target,i,arr_w);
                      imp_counter += 1;

                      if (cal_pos == -1){

                      }
                      

                    }








                    }
                }
            }




            function range_reset(){
              arr_range = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];
            }

            //초기화 목적
            //맨 처음에 이게 시전된다.
            function init() {
              //arr_w = [-1,-1,-1,-1,-1,-1,-1,-1,-1];
              //arr_r = [-1,-1,-1,-1,-1,-1,-1,-1,-1];

              ban_r = [-1,-1];
              ban_w = [-1,-1];

              arr_w = [4,7,5,6,3,0,-1,-1,2,1];
              arr_test = [-1,-1,-1,-1,-1,-1,-1,-1]
              //arr_w = [-1,-1,-1,-1,3,0,-1,-1,2,1];
              arr_r = [19,16,18,17,20,23,-1,-1,21,22];

              arr_range = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];
              //arr_range = [[2,1,1,1],[0,2,0,1],[1,1,0,0],[0,1,1,0],[0,0,1,1],[2,0,2,1]];
              step = 3;

                context = document.getElementById('canvas').getContext('2d');
                drawBackground();
                draw();
            }

            /*사용자가 발사 버튼을 누르면 호출된다.*/
            function start() {
                init();
                velocity = Number(document.getElementById('velocity').value);
                angle = Number(document.getElementById('angle').value);
                var angleR = angle * Math.PI / 180;

                ballVx = velocity * Math.cos(angleR);
                ballVy = -velocity * Math.sin(angleR);

                draw();
                timer = setInterval(calculate, 100);
                return false
            }

            /*공의 현재 속도와 위치를 업데이트한다.*/
            function calculate() {
                ballVy = ballVy + 1.98;

                ballX = ballX + ballVx;
                ballY = ballY + ballVy;

                /*공이 목표물에 맞았으면*/
                if ((ballX >= 450) && (ballX <= 480) && (ballY >= 60) && (ballY <= 210)) {
	                score++;
	                document.getElementById("score").innerHTML = "점수= " + score;
	                clearInterval(timer);
                }
                /*공이 경계를 벗어났으면*/
                if (ballY >= 300 || ballY < 0) {
                    clearInterval(timer);
                }
                draw();
            }

        </script>
    </head>
    <body onload="init();">
        <canvas id="canvas" width="480" height="540"></canvas>
        <div id="control">
            속도 <input id="velocity" value="30" type="number" min="0" max="100" step="1">
            각도 <input id="angle" value="45" type="number" min="0" max="90" step="1">
            <div id="score">점수 = 0</div>
            <button onclick="start()">발사</button>
        </div>
    </body>
</html>
